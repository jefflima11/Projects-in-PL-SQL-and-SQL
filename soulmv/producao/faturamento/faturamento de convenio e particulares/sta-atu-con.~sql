/*CREATED BY
NAME: JEFFERSON LIMA GONCALVES
CARGO: ANALISTA E DESENVOLVEDOR DE SISTEMAS JR
DATA: 01/04/2024
TITULO: STATUS ATUAL DA CONTA
DESCRICAO:
FILTROS:

ULTIMA ATUALIZAÇÃO
RESPONSAVEL:
DATA:
MOTIVO:
DESCRIÇÃO:
*/
SELECT *

FROM(
		SELECT  A.CD_ATENDIMENTO ATENDIMENTO,
				RF.CD_REG_FAT CONTA,
				C.NM_CONVENIO CONVENIO,
				CASE
				  WHEN  RF.SN_FECHADA = 'S' AND CR.DT_EMISSAO IS NOT NULL AND ICR.TP_QUITACAO = 'C'
					THEN 'CONTA RECEBIDA  - QUITACAO COMPROMETIDA'
				  WHEN  RF.SN_FECHADA = 'S' AND CR.DT_EMISSAO IS NOT NULL AND ICR.TP_QUITACAO = 'V'
					THEN 'CONTA RECEBIDA  - QUITACAO PREVISTA'
				  WHEN  RF.SN_FECHADA = 'S' AND CR.DT_EMISSAO IS NOT NULL AND ICR.TP_QUITACAO = 'P'
					THEN 'CONTA RECEBIDA  - QUITACAO PARCIAL'	
				  WHEN  RF.SN_FECHADA = 'S' AND CR.DT_EMISSAO IS NOT NULL AND ICR.TP_QUITACAO = 'Q'
					THEN 'CONTA RECEBIDA  - QUITACAO TOTAL'
				  WHEN  RF.SN_FECHADA = 'S' AND CR.DT_EMISSAO IS NOT NULL AND ICR.TP_QUITACAO = 'L'
					THEN 'CONTA RECEBIDA  - QUITACAO CANCELADA'
				  WHEN  RF.SN_FECHADA = 'S' AND CR.DT_EMISSAO IS NOT NULL AND ICR.TP_QUITACAO = 'R'
					THEN 'CONTA RECEBIDA  - QUITACAO PROTESTADA'
				  WHEN  RF.SN_FECHADA = 'S' AND CR.DT_EMISSAO IS NOT NULL AND ICR.TP_QUITACAO = 'G'
					THEN 'CONTA RECEBIDA  - QUITACAO COM GLOSA'					
				  WHEN  RF.SN_FECHADA = 'S' AND CR.DT_EMISSAO IS NOT NULL
					THEN  'CONTA RECEBIDA'
				  WHEN  RF.SN_FECHADA = 'S'
					THEN  'CONTA FECHADA'
				  WHEN  RF.SN_FECHADA = 'N'
					THEN  'CONTA ABERTA'
				  ELSE 'TST'
				END STATUS,
				((DECODE(SUM(RF.VL_TOTAL_CONTA),NULL,0
											  ,RF.VL_TOTAL_CONTA)-
				 (DECODE(SUM(ICR.VL_SOMA_RECEBIDO),NULL,0
												 ,ICR.VL_SOMA_RECEBIDO))-
				 (DECODE(SUM(CR.VL_DESCONTO),NULL,0
											,CR.VL_DESCONTO)))+
				 (DECODE(SUM(CR.VL_ACRESCIMO),NULL,0
											 ,CR.VL_ACRESCIMO)))VL_INA
				
		FROM    DBAMV.ATENDIME A,
				DBAMV.REG_FAT RF,
				DBAMV.CONVENIO C,
				DBAMV.REMESSA_FATURA RFA,
				DBAMV.FATURA F,
				DBAMV.CON_REC CR,
				DBAMV.ITCON_REC ICR,
				DBAMV.RECCON_REC RCR
				
		WHERE   A.CD_ATENDIMENTO = RF.CD_ATENDIMENTO
		  AND   RF.CD_CONVENIO = C.CD_CONVENIO
		  AND   RF.CD_REMESSA = RFA.CD_REMESSA(+)
		  AND   RFA.CD_FATURA = F.CD_FATURA(+)
		  AND   RF.CD_REG_FAT = CR.CD_REG_FAT(+)
		  AND   CR.CD_CON_REC = ICR.CD_CON_REC(+)
		  AND   ICR.CD_ITCON_REC = RCR.CD_ITCON_REC(+)

		  AND   TO_CHAR(RF.DT_INICIO,'MMYYYY') LIKE '%{vData}%'
		  AND   A.CD_MULTI_EMPRESA = 1
		/*  AND   ICR.CD_ITCON_REC = 63092*/
		/*  AND   RF.CD_REG_FAT = 100243*/
		/*  AND   RF.CD_ATENDIMENTO  = 1337977*/

		GROUP BY  A.CD_ATENDIMENTO,
				RF.CD_REG_FAT,
				C.NM_CONVENIO,
				CASE
				  WHEN  RF.SN_FECHADA = 'S' AND CR.DT_EMISSAO IS NOT NULL AND ICR.TP_QUITACAO = 'C'
					THEN 'CONTA RECEBIDA  - QUITACAO COMPROMETIDA'
				  WHEN  RF.SN_FECHADA = 'S' AND CR.DT_EMISSAO IS NOT NULL AND ICR.TP_QUITACAO = 'V'
					THEN 'CONTA RECEBIDA  - QUITACAO PREVISTA'
				  WHEN  RF.SN_FECHADA = 'S' AND CR.DT_EMISSAO IS NOT NULL AND ICR.TP_QUITACAO = 'P'
					THEN 'CONTA RECEBIDA  - QUITACAO PARCIAL'	
				  WHEN  RF.SN_FECHADA = 'S' AND CR.DT_EMISSAO IS NOT NULL AND ICR.TP_QUITACAO = 'Q'
					THEN 'CONTA RECEBIDA  - QUITACAO TOTAL'
				  WHEN  RF.SN_FECHADA = 'S' AND CR.DT_EMISSAO IS NOT NULL AND ICR.TP_QUITACAO = 'L'
					THEN 'CONTA RECEBIDA  - QUITACAO CANCELADA'
				  WHEN  RF.SN_FECHADA = 'S' AND CR.DT_EMISSAO IS NOT NULL AND ICR.TP_QUITACAO = 'R'
					THEN 'CONTA RECEBIDA  - QUITACAO PROTESTADA'
				  WHEN  RF.SN_FECHADA = 'S' AND CR.DT_EMISSAO IS NOT NULL AND ICR.TP_QUITACAO = 'G'
					THEN 'CONTA RECEBIDA  - QUITACAO COM GLOSA'	                
                  WHEN  RF.SN_FECHADA = 'S' AND CR.DT_EMISSAO IS NOT NULL
                    THEN  'CONTA RECEBIDA'
                  WHEN  RF.SN_FECHADA = 'S'
                    THEN  'CONTA FECHADA'
                  WHEN  RF.SN_FECHADA = 'N'
                    THEN  'CONTA ABERTA'
                  ELSE 'TST'
                END,
                ICR.VL_SOMA_RECEBIDO,
                CR.VL_DESCONTO,
                RF.VL_TOTAL_CONTA,
                CR.VL_ACRESCIMO
                )
WHERE  CONVENIO LIKE ('%{vConvenio}%')
  AND  STATUS LIKE ('%{vstatus}%')
  AND  {vfull}                
